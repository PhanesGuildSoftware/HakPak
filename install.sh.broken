#!/bin/bash

# HakPak Universal Installer
# Single comprehensive installer with all options
# Author: Teyvone Wells @ PhanesGuild Software LLC

set -euo pipefail

# Version and branding
readonly HAKPAK_VERSION="1.0"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly INSTALL_DIR="/opt/hakpak"
readonly BIN_DIR="/usr/local/bin"
readonly DESKTOP_DIR="/usr/share/applications"
readonly ICONS_DIR="/usr/share/icons"

# Colors
declare -r GREEN='\033[0;32m'
declare -r RED='\033[0;31m'
declare -r YELLOW='\033[1;33m'
declare -r BLUE='\033[0;34m'
declare -r PURPLE='\033[0;35m'
declare -r CYAN='\033[0;36m'
declare -r BOLD='\033[1m'
declare -r NC='\033[0m'

# Output functions
print_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
print_error() { echo -e "${RED}[âœ—]${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
print_info() { echo -e "${BLUE}[i]${NC} $1"; }

show_header() {
    clear
    echo -e "${BOLD}${CYAN}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—${NC}"
    echo -e "${BOLD}${CYAN}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•${NC}"
    echo -e "${BOLD}${CYAN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•${NC} "
    echo -e "${BOLD}${CYAN}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—${NC} "
    echo -e "${BOLD}${CYAN}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—${NC}"
    echo -e "${BOLD}${BLUE}â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•${NC}"
    echo
    echo -e "${BOLD}${GREEN}Universal Kali Tools Installer v${HAKPAK_VERSION}${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}Author:${NC} Teyvone Wells @ PhanesGuild Software LLC"
    echo -e "${BLUE}Support:${NC} https://www.phanesguild.llc"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

show_usage() {
    echo "Usage: $0 [OPTION]"
    echo ""
    echo "Installation Options:"
    echo "  --desktop     Install with desktop integration"
    echo "  --system      Install system-wide only (no desktop)"
    echo "  --quick       Quick installation with defaults"
    echo ""
    echo "Management Options:"
    echo "  --uninstall   Remove HakPak installation"
    echo "  --reinstall   Uninstall and reinstall with desktop"
    echo "  --check       Check installation status"
    echo ""
    echo "Information:"
    echo "  --help        Show this help message"
    echo "  --version     Show version information"
    echo ""
    echo "Installation includes:"
    echo "  â€¢ Main HakPak script (/opt/hakpak/)"
    echo "  â€¢ System-wide command (hakpak)"
    echo "  â€¢ License verification system (for Pro features)"
    echo "  â€¢ Library modules (lib/)"
    echo "  â€¢ Desktop integration (with --desktop)"
    echo ""
    echo "Default: Interactive installation with prompts"
}

# Check system requirements
check_requirements() {
    print_info "Checking system requirements..."
    
    # Verify we're on a Debian-based system
    if [[ ! -f /etc/os-release ]]; then
        print_error "Cannot detect distribution - /etc/os-release not found"
        exit 1
    fi
    
    local distro_id=$(grep '^ID=' /etc/os-release | cut -d'=' -f2- | tr -d '"')
    case "$distro_id" in
        ubuntu|debian|pop|linuxmint|parrot)
            print_success "Supported distribution detected"
            ;;
        *)
            print_warning "Distribution may not be fully supported"
            print_info "Officially supported: Ubuntu, Debian, Pop!_OS, Linux Mint, Parrot OS"
            ;;
    esac
    
    # Check sudo access
    if ! sudo -n true 2>/dev/null; then
        if ! sudo true; then
            print_error "This installation requires sudo privileges"
            exit 1
        fi
    fi
    print_success "Administrative access confirmed"
    
    # Check required commands
    local required_commands=("apt" "dpkg" "curl")
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            print_error "Required command not found: $cmd"
            exit 1
        fi
    done
    print_success "Required system commands available"
    
    # Check disk space (minimum 1GB)
    local available_kb=$(df / | awk 'NR==2 {print $4}')
    local available_gb=$((available_kb / 1024 / 1024))
    if [[ $available_kb -lt 1048576 ]]; then
        print_warning "Low disk space: ${available_gb}GB available (minimum 1GB recommended)"
    else
        print_success "Sufficient disk space: ${available_gb}GB available"
    fi
}

# Verify installation files
verify_files() {
    print_info "Verifying installation files..."
    
    local required_files=(
        "hakpak.sh"
    )
    
    local optional_files=(
        "lib/license.sh"
        "keys/public.pem"
    )
    
    for file in "${required_files[@]}"; do
        if [[ ! -f "$SCRIPT_DIR/$file" ]]; then
            print_error "Required file not found: $file"
            print_info "Please ensure you're running this from the complete HakPak directory"
            exit 1
        fi
    done
    
    for file in "${optional_files[@]}"; do
        if [[ -f "$SCRIPT_DIR/$file" ]]; then
            print_info "Found optional file: $file"
        fi
    done
    
    print_success "All required files present"
}

# Install HakPak system files
install_system_files() {
    print_info "Installing HakPak system files..."
    
    # Create installation directory
    sudo mkdir -p "$INSTALL_DIR"
    sudo mkdir -p "$BIN_DIR"
    sudo mkdir -p "/usr/share/hakpak"
    
    # Copy main files
    sudo cp "$SCRIPT_DIR/hakpak.sh" "$INSTALL_DIR/"
    sudo chmod +x "$INSTALL_DIR/hakpak.sh"
    
    # Copy library files
    if [[ -d "$SCRIPT_DIR/lib" ]]; then
        sudo cp -r "$SCRIPT_DIR/lib" "$INSTALL_DIR/"
        print_info "Library files installed"
    fi
    
    # Copy public key for license verification
    if [[ -f "$SCRIPT_DIR/keys/public.pem" ]]; then
        sudo cp "$SCRIPT_DIR/keys/public.pem" "/usr/share/hakpak/"
        sudo chmod 644 "/usr/share/hakpak/public.pem"
        print_info "License verification key installed"
    fi
    
    # Create system-wide executable
    sudo ln -sf "$INSTALL_DIR/hakpak.sh" "$BIN_DIR/hakpak"
    
    print_success "System files installed to $INSTALL_DIR"
}

# Install desktop integration
install_desktop_integration() {
    print_info "Installing desktop integration..."
    
    # Create directories
    sudo mkdir -p "$DESKTOP_DIR"
    
    # Create desktop entry that launches hakpak directly in terminal
    sudo tee "$DESKTOP_DIR/hakpak.desktop" > /dev/null << 'EOF'
[Desktop Entry]
Type=Application
Name=HakPak
Comment=Universal Kali Tools Installer
Exec=sh -c 'hakpak; read -p "Press Enter to close..."'
Icon=utilities-terminal
Terminal=true
Categories=System;Security;
Keywords=security;tools;kali;hacking;penetration testing;
StartupNotify=true
EOF
    
    # Update desktop database
    if command -v update-desktop-database &> /dev/null; then
        sudo update-desktop-database "$DESKTOP_DIR" 2>/dev/null || true
    fi
    
    print_success "Desktop integration installed (launches in terminal)"
}

# Uninstall HakPak
uninstall_hakpak() {
    print_info "Uninstalling HakPak..."
    
    # Remove system files
    sudo rm -rf "$INSTALL_DIR" 2>/dev/null || true
    sudo rm -f "$BIN_DIR/hakpak" 2>/dev/null || true
    sudo rm -rf "/usr/share/hakpak" 2>/dev/null || true
    
    # Remove desktop integration
    sudo rm -f "$DESKTOP_DIR/hakpak.desktop" 2>/dev/null || true
    
    # Update desktop database
    if command -v update-desktop-database &> /dev/null; then
        sudo update-desktop-database "$DESKTOP_DIR" 2>/dev/null || true
    fi
    
    print_success "HakPak uninstalled successfully"
}

# Check installation status
check_installation() {
    show_header
    print_info "Checking HakPak installation status..."
    echo
    
    # Check if hakpak command is available
    if command -v hakpak &> /dev/null; then
        print_success "HakPak command available in PATH"
        echo -e "  Location: ${BLUE}$(which hakpak)${NC}"
    else
        print_error "HakPak command not found in PATH"
    fi
    
    # Check installation directory
    if [[ -d "$INSTALL_DIR" ]]; then
        print_success "Installation directory exists: $INSTALL_DIR"
        if [[ -f "$INSTALL_DIR/hakpak.sh" ]]; then
            print_success "Main script found: $INSTALL_DIR/hakpak.sh"
        else
            print_error "Main script missing: $INSTALL_DIR/hakpak.sh"
        fi
        if [[ -d "$INSTALL_DIR/lib" ]]; then
            print_success "Library directory found: $INSTALL_DIR/lib"
        else
            print_warning "Library directory not found (optional)"
        fi
    else
        print_error "Installation directory not found: $INSTALL_DIR"
    fi
    
    # Check license verification key
    if [[ -f "/usr/share/hakpak/public.pem" ]]; then
        print_success "License verification key found: /usr/share/hakpak/public.pem"
    else
        print_warning "License verification key not found (Pro features disabled)"
    fi
    
    # Check desktop integration
    if [[ -f "$DESKTOP_DIR/hakpak.desktop" ]]; then
        print_success "Desktop integration installed: $DESKTOP_DIR/hakpak.desktop"
    else
        print_warning "Desktop integration not installed"
    fi
    
    echo
    if command -v hakpak &> /dev/null; then
        echo
    if command -v hakpak &> /dev/null; then
        print_info "Run ${BLUE}hakpak --version${NC} to test the installation"
    fi
}

# Interactive installation
    fi
}
    
    print_success "HakPak uninstalled successfully"
}

# Check installation status
check_installation() {
    print_info "Checking HakPak installation status..."
    
    if [[ -f "$BIN_DIR/hakpak" && -d "$INSTALL_DIR" ]]; then
        print_success "HakPak is installed (system-wide)"
        
        if [[ -f "$DESKTOP_DIR/hakpak.desktop" ]]; then
            print_success "Desktop integration is installed"
        else
            print_warning "Desktop integration is not installed"
        fi
        
        # Show version
        if command -v hakpak &> /dev/null; then
            local version=$(hakpak --version 2>/dev/null | head -1 || echo "Unknown")
            print_info "Installed version: $version"
        fi
    else
        print_warning "HakPak is not installed"
    fi
}

# Interactive installation
interactive_install() {
    print_info "Starting interactive installation..."
    echo
    
    print_info "HakPak will be installed with:"
    echo "  â€¢ Core tool installation system"
    echo "  â€¢ License verification for Pro features"
    echo "  â€¢ Modular library system"
    echo
    
    echo "Choose installation type:"
    echo "1) Full installation (system + desktop integration)"
    echo "2) System-wide only (command-line access)"
    echo "3) Check current installation"
    echo "4) Exit"
    echo
    
    read -rp "Enter your choice [1-4]: " choice
    echo
    
    case "$choice" in
        1) install_with_desktop ;;
        2) install_system_only ;;
        3) check_installation ;;
        4) exit 0 ;;
        *) print_error "Invalid choice. Please try again."; interactive_install ;;
    esac
}

# Full installation with desktop
install_with_desktop() {
    show_header
    print_info "Installing HakPak with desktop integration..."
    echo
    
    check_requirements
    verify_files
    install_system_files
    install_desktop_integration
    
    echo
    print_success "ðŸŽ‰ HakPak installation completed successfully!"
    print_info "You can now:"
    echo -e "  â€¢ Run ${BLUE}hakpak${NC} from any terminal"
    echo -e "  â€¢ Find HakPak in your applications menu"
    echo -e "  â€¢ Access tools through the desktop launcher"
    echo -e "  â€¢ Install HakPak Pro license for enterprise features"
    echo
    print_info "For Pro features, see: ${BLUE}hakpak --enterprise-status${NC}"
    echo
}

# System-only installation
install_system_only() {
    show_header
    print_info "Installing HakPak (system-wide only)..."
    echo
    
    check_requirements
    verify_files
    install_system_files
    
    echo
    print_success "ðŸŽ‰ HakPak system installation completed!"
    print_info "You can now run ${BLUE}hakpak${NC} from any terminal"
    echo
    print_info "For Pro features, see: ${BLUE}hakpak --enterprise-status${NC}"
    echo
}

# Quick installation
quick_install() {
    show_header
    print_info "Quick installation with defaults..."
    install_with_desktop
}

# Reinstall function
reinstall_hakpak() {
    show_header
    print_info "Reinstalling HakPak..."
    echo
    
    uninstall_hakpak
    echo
    install_with_desktop
}

# Main function
main() {
    case "${1:-}" in
        --desktop|--full)   install_with_desktop ;;
        --system)           install_system_only ;;
        --quick)            quick_install ;;
        --uninstall)        uninstall_hakpak ;;
        --reinstall)        reinstall_hakpak ;;
        --check|--status)   check_installation ;;
        --help)             show_usage; exit 0 ;;
        --version)          echo "HakPak Installer v$HAKPAK_VERSION"; exit 0 ;;
        "")                 interactive_install ;;
        *)                  echo "Unknown option: $1"; echo; show_usage; exit 1 ;;
    esac
}

# Run main function
show_header
main "$@"
